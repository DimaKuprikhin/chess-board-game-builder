# Chess board game builder
**Chess board game builder** - клиент-серверное приложение, позволяющее пользователю определять правила (стартовая позиция, ходы фигур, условия победы) для игры на шахматной доске и играть в игру с этими правилами по сети.

## Руководство пользователя
### Создание игры
Для создания игры, пользователю необходимо загрузить файл со скриптом, удовлетворяющему определенному интерфейсу, и выбрать сторону, за которую он будет игрыть. Далее, запрос на создание игры отправляется на сервер, и пользователь получает код для присоединения, который может использовать другой человек. После того, как другой игрок ввел созданный код, оба игрока начинают игру.

### Ходы
Загруженный скрипт определяет ходы, которые может сделать в определенной позиции один из игроков. Для игрока возможные ходы представлены в виде визуальной подсказки - когда игрок кликает на фигуру, на полях, на которые ее можно переместить, появляются синие кружки.

### Предположения об играх
Приложение ограничивает множество игр, возможных для обработки:
- в игре участвуют два игрока: условные белые и черные
- первый ход в игре делают белые
- после каждого хода, право хода переходит противоположенной стороне
- игры может завершиться 3 исходами: победа белых, победа черных, ничья
- игры ограничена 200 ходами - при достижении лимита объявляется ничья

### Скрипт
Для корректной работы, пользовательский скрипт должен быть написан на языке Python и состоять из 1 файла, размером не более 1 Мб. Любой вызов функции из заданного интерфейса должен завершаться за 0.1 секунду и использовать не более 100 Мб памяти (в том числе, эти ограничения предотвращают \[не\]намеренные бесконечные циклы, рекурсии). Скрипт в процессе своего выполнения не должен приводить к необработанным ошибкам или исключениям. Пример скрипта можно найти в `server_backend/test_data/chess_rules.py`.

### Интерфейс скрипта
Пользовательский скрипт должен реализовывать следующий интерфейс (содержать функции):
- `def get_starting_state():` - возвращает начальное положение фигур на доске и возможные ходы для белых, а также дополнительные данные, которые могут потребоваться скрипту при следующих вызовах. Эти дополнительные данные сохраняются между вызовами скрипта и передаются на каждый новый вызов, что позволяет получать данные, недоступные из позиции фигур (например, в шахматах это может быть информация о том, ходил ли король и может ли он сделать рокировку).
- `def make_move(pieces, move, next_turn, additional_data):` - обрабатывает очередной ход в игре. Получает на вход состояние игры до хода (полученной из предыдущего вызова этой функции), сделанный ход, и возвращает состояние игры после хода.
- Параметры `make_move()`:
    - `pieces`: python лист, состоящий из фигур, стоящих на доске.
    - `move`: сделанный ход.
    - `next_turn`: сторона, к которой перейдет право хода после этого хода (может быть `'white'` или `'black'`).
    - `additional_data`: дополнительные данные, сохраняющиеся и передающиейся между вызовами `make_move()`.
- Возвращаемое значение `get_starting_state()` и `make_move()` - python словарь, состоящий из следующих пар ключ-значение:
    - `'pieces'`: python лист фигур, присутствующих на доске.
    - `'possible_positions'`: python лист возможных ходов.
    - `'additional_data'`: произвольные данные, которые будут сохранены и переданы как аргумент при следующем вызове `make_move()`
    - `'status'`: статус игры. Может быть `'running'`, если игра продолжается; `'white won'`, `'black won'` или `'draw'`, если игра закончилась с соответствующим результатом.\

### Формат данных
Структура фигуры (из которых состоит параметр `pieces` и значение в возвращаемом словаре с ключем `'pieces'`) - python словарь, содержащий следующие пары ключ-значение:
- `'color'`: цвет фигуры. Может быть `'white'` или `'black'`.
- `'name'`: название фигуры. В данный момент поддерживаются только фигуры шахмат: `'pawn'`, `'knight'`, `'bishop'`, `'rook'`, `'queen'`, `'king'`.
- `'x'`: номер столбца, на которой располагается фигура (отсчет начинается с 0, что соответствует столбцу "A" на ашахматной доске).
- `'y'`: номер ряда, на котором располагается фигура (отсчет начинается с 0, что соответствует ряду 1 на шахматной доске).

Пример, черный ферзь на поле d8:
```
{
    'color': 'black',
    'name': 'queen',
    'x': 3,
    'y': 7
}
```

Структура ходов, из которых состоят параметры `possible_moves` и `move` - python словарь, содержащий следующие пары ключ-значение:
- `'from_x'`: номер столбца, в котором начинается ход и в котором изначально стоит фигура.
- `'from_y'`: номер ряда, в котором начинается ход и в котором изначально стоит фигура.
- `'to_x'`: номер столбца, в который перемещается фигура.
- `'to_y'`: номер ряда, в который перемещается фигура.

Пример, ход с e2 на e4:
```
{
    'from_x': 4,
    'from_y': 1,
    'to_x': 4,
    'to_y': 3
}
```

## Руководство разработчика
Для разработки сервера используется python + flask, для клиента - java + maven + swing + intellij idea.

### Настройка окружения сервера
Создаем виртуальное окружение:
```
virtualenv venv
source venv/bin/activate
```

Устанавливаем необходимые модули:
```
pip install Flask
pip install typing_extensions
```

Инициализируем базу данных и создаем необходимые директории для скриптов.
```
make init
```

Запускаем локальный сервер:
```
make run
```

### Тестирование сервера
Устанавливаем необходимые модули и запускаем тесты.
```
pip install pytest
make test
```

### Сборка сервера
[Детальнее тут](https://flask.palletsprojects.com/en/2.2.x/tutorial/deploy/)

Устанавливаем `wheel` и собираем дистрибуционный файл:
```
pip install wheel
python setup.py bdist_wheel
```

Собранный файл: `dist/flaskr-1.0.0-py3-none-any.whl`

### Запуск в продакшн сервера
Настраиваем окружение, создаем базу данных и необходимые директории:
```
virtualenv venv
source venv/bin/activate
pip install Flask
pip install typing_extensions
pip install flaskr-1.0.0-py3-none-any.whl
flask --app flaskr init-db
mkdir script
```

Запускаем:
```
pip install waitress
waitress-serve --call 'flaskr:create_app'
```
